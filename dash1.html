<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Apresentação Games</title>
  <link rel="stylesheet" href="game-scores.css">
</head>
<body>
  <div class="wrap">
    <h1>
      Apresentação – <span id="teacherLabel">—</span>
      <span class="muted">·</span> <span id="classLabel">—</span>
    </h1>

    <div class="row">
      <select id="teacherSelect" title="Professor"></select>
      <select id="classSelect" title="Turma"></select>
      <button class="btn blue" id="printBtn">Imprimir / Salvar PDF</button>
      <button class="btn red" id="resetBtn">Resetar Turma</button>
    </div>

    <div id="grid" class="grid"></div>
    <div id="msg" class="muted"></div>
  </div>

<script>
const API_BASE = 'https://script.google.com/macros/s/AKfycbzq9FNFIENdA7TLUj_SXs5G0ZZGCJ9IWDkhsBkt2iKL5CuM7sMCUDga8auyPz5pHk5_8A/exec';

function jsonp(url){
  return new Promise((resolve, reject)=>{
    const cb = 'cb_' + Math.random().toString(36).slice(2);
    const s = document.createElement('script');
    window[cb] = (data) => { resolve(data); delete window[cb]; s.remove(); };
    s.onerror = () => { delete window[cb]; reject(new Error('Falha JSONP')); };
    s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
    document.body.appendChild(s);
  });
}
const el = id => document.getElementById(id);
const pct = x => Math.max(0, Math.min(100, Math.round(x)));

let CURRENT_TEACHER = null;
let CURRENT_CLASS = null;
let REFRESHING = false;
let TIMER = null;

function cardSkeleton(id){
  const d = document.createElement('div');
  d.className = 'card';
  d.dataset.id = id;
  d.innerHTML = `
    <div class="head">
      <div class="rank">–</div>
      <div class="name">—</div>
      <div class="total">0.00 pts</div>
    </div>
    <div class="bar">
      <div class="fill" style="width:0%"></div>
      <div class="runner" style="left:-17px">
        <img src="https://i.imgur.com/8Km9tLL.png" alt=""/>
      </div>
    </div>
    <div class="members"></div>
  `;
  return d;
}

function updateCard(dom, g, idx){
  const p = pct(g.progress);
  const img = g.image || 'https://i.imgur.com/8Km9tLL.png';
  dom.querySelector('.rank').textContent = idx + 1;
  dom.querySelector('.name').textContent = g.name;
  dom.querySelector('.total').textContent = `${Number(g.total).toFixed(2)} pts`;
  dom.querySelector('.fill').style.width = p + '%';
  dom.querySelector('.runner').style.left = `calc(${p}% - 17px)`;
  const pic = dom.querySelector('.runner img');
  if (pic.src !== img) pic.src = img;
  dom.querySelector('.members').textContent = (g.members||[]).join(', ');
}

function syncStandings(list){
  const grid = el('grid');
  const wantIds = list.map(g => g.id);
  const have = new Map(Array.from(grid.children).map(n => [n.dataset.id, n]));

  // Atualiza/Cria em ordem desejada (evita limpar a grade)
  const frag = document.createDocumentFragment();
  list.forEach((g, idx) => {
    let node = have.get(g.id);
    if (!node) {
      node = cardSkeleton(g.id);
      node.style.opacity = '0';
      // entra suavemente
      requestAnimationFrame(()=> node.style.opacity = '');
    }
    updateCard(node, g, idx);
    frag.appendChild(node);
    have.delete(g.id); // marca como processado
  });

  // Remove os que sobraram (não existem mais) com fade-out
  have.forEach(node => {
    node.classList.add('fade-out');
    setTimeout(() => node.remove(), 200); // casa com .2s do CSS
  });

  // Reordena inserindo o fragment (mover nós existentes não pisca)
  grid.appendChild(frag);
}

async function loadTeachers(){
  try{
    el('msg').textContent = 'Carregando professores...';
    const data = await jsonp(`${API_BASE}?route=teachers`);
    const teachers = data.teachers || [];
    const sel = el('teacherSelect'); sel.innerHTML = '';
    teachers.forEach(t=>{
      const o=document.createElement('option'); o.value=t.id; o.textContent=t.name; sel.appendChild(o);
    });
    const urlTeacher = new URLSearchParams(location.search).get('teacher');
    const saved = localStorage.getItem('selectedTeacher');
    CURRENT_TEACHER = urlTeacher || saved || (teachers[0] && teachers[0].id) || null;
    if (CURRENT_TEACHER && teachers.some(t=>t.id===CURRENT_TEACHER)) sel.value = CURRENT_TEACHER;
    else { CURRENT_TEACHER = teachers[0] ? teachers[0].id : null; if (CURRENT_TEACHER) sel.value=CURRENT_TEACHER; }
    el('teacherLabel').textContent = (teachers.find(t=>t.id===CURRENT_TEACHER)||{}).name || '—';
    el('msg').textContent = teachers.length ? '' : 'Nenhum professor cadastrado.';
  }catch(err){
    el('msg').textContent = 'Erro ao carregar professores: ' + err.message;
  }
}

async function loadClasses(){
  const selClass = el('classSelect'); selClass.innerHTML = '';
  if (!CURRENT_TEACHER){
    el('msg').textContent = 'Selecione um professor.';
    el('classLabel').textContent = '—';
    return;
  }
  try{
    el('msg').textContent = 'Carregando turmas...';
    const data = await jsonp(`${API_BASE}?route=classes&teacher=${encodeURIComponent(CURRENT_TEACHER)}`);
    const classes = data.classes || [];
    classes.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; selClass.appendChild(o); });

    const urlClass = new URLSearchParams(location.search).get('class');
    const savedKey = `selectedClass_${CURRENT_TEACHER}`;
    const saved = localStorage.getItem(savedKey);
    CURRENT_CLASS = urlClass || saved || data.defaultClass || classes[0] || null;

    if (CURRENT_CLASS && classes.includes(CURRENT_CLASS)) selClass.value = CURRENT_CLASS;
    else { CURRENT_CLASS = classes[0] || null; if (CURRENT_CLASS) selClass.value = CURRENT_CLASS; }

    el('classLabel').textContent = CURRENT_CLASS || '—';
    el('msg').textContent = '';
  }catch(err){
    el('msg').textContent = 'Erro ao carregar turmas: ' + err.message;
  }
}

async function refreshStandings(){
  if (!CURRENT_TEACHER || !CURRENT_CLASS || REFRESHING) return;
  REFRESHING = true;
  try{
    const data = await jsonp(`${API_BASE}?route=standings&teacher=${encodeURIComponent(CURRENT_TEACHER)}&class=${encodeURIComponent(CURRENT_CLASS)}`);
    const list = data.standings || [];
    syncStandings(list);
    el('msg').textContent = list.length ? '' : 'Sem grupos para esta turma.';
  }catch(err){
    el('msg').textContent = 'Erro ao carregar: ' + err.message;
  }finally{
    REFRESHING = false;
  }
}

async function resetClass(){
  if (!CURRENT_TEACHER || !CURRENT_CLASS) { alert('Selecione professor e turma.'); return; }
  const ok = confirm('Você já salvou em PDF? Ao confirmar, TODOS os grupos, alunos e pontuações desta turma serão apagados.');
  if (!ok) return;
  try{
    const res = await jsonp(`${API_BASE}?route=resetClass&teacher=${encodeURIComponent(CURRENT_TEACHER)}&class=${encodeURIComponent(CURRENT_CLASS)}&confirm=yes`);
    if (res && res.ok){
      alert(`Reset concluído para ${CURRENT_CLASS}.\nRemovidos: ${res.cleared.groups} grupos, ${res.cleared.members} alunos, ${res.cleared.scores} pontuações.`);
      refreshStandings();
    } else if (res && res.confirmRequired) {
      alert('Confirmação necessária (&confirm=yes).');
    } else {
      alert('Falha ao resetar.');
    }
  }catch(e){
    alert('Erro: ' + e.message);
  }
}

// Eventos
el('teacherSelect').addEventListener('change', async ()=>{
  CURRENT_TEACHER = el('teacherSelect').value;
  localStorage.setItem('selectedTeacher', CURRENT_TEACHER);
  el('teacherLabel').textContent = el('teacherSelect').selectedOptions[0]?.textContent || '—';
  await loadClasses();
  await refreshStandings();
});
el('classSelect').addEventListener('change', ()=>{
  CURRENT_CLASS = el('classSelect').value;
  localStorage.setItem(`selectedClass_${CURRENT_TEACHER}`, CURRENT_CLASS);
  el('classLabel').textContent = CURRENT_CLASS || '—';
  refreshStandings();
});
el('printBtn').addEventListener('click', () => window.print());
el('resetBtn').addEventListener('click', resetClass);

// Init + polling suave
(async function init(){
  await loadTeachers();
  await loadClasses();
  await refreshStandings();
  if (TIMER) clearInterval(TIMER);
  TIMER = setInterval(refreshStandings, 15000); // sem piscar
})();
</script>
</body>
</html>
