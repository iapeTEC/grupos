<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Gameboard ‚Äì Plataforma</title>
  <link rel="stylesheet" href="game-scores.css">
  <link rel="preconnect" href="https://script.google.com">
  <link rel="dns-prefetch" href="https://script.google.com">
  <link rel="preconnect" href="https://script.googleusercontent.com">
  <link rel="dns-prefetch" href="https://script.googleusercontent.com">
</head>
<body>
  <div class="wrap">

    <!-- Topbar -->
    <div class="topbar">
      <div class="top-left">
        <div class="logo">üéÆ Gameboard</div>
        <div class="divider-vert"></div>
        <div id="loginArea">
          <label class="label-lg">Professor</label>
          <select id="teacherSelect" class="big-select"></select>
          <button class="btn green btn-lg" id="btnCreateTeacher">Cadastrar professor +</button>
          <button class="btn blue" id="btnLogin">Entrar</button>
        </div>
        <div id="userArea" class="hidden">
          <span class="label-lg" id="userName"></span>
          <button class="btn red" id="btnLogout">Sair</button>
        </div>
      </div>
      <div class="top-right">
        <button class="btn blue" id="goScore">Ir para p√°gina de pontua√ß√µes ‚Üí</button>
      </div>
    </div>

    <!-- Se√ß√µes do app (aparecem s√≥ ap√≥s login) -->
    <div id="appSections" class="hidden">

      <!-- Classes -->
      <div class="section">
        <div class="section-head">
          <h2>Classes</h2>
          <div class="muted">Selecione uma classe para ver os grupos.</div>
        </div>
        <div id="classGrid" class="card-grid"></div>
        <div style="margin-top:10px">
          <button class="btn purple" id="btnCreateClass">Criar classe +</button>
        </div>
      </div>

      <div class="divider-hz"></div>

      <!-- Grupos -->
      <div class="section">
        <div class="section-head">
          <h2>Grupos <span class="muted" id="classNameBadge">‚Äî</span></h2>
          <div class="section-actions">
            <button class="btn guava" id="resetGroups">Resetar grupos</button>
            <button class="btn green" id="btnCreateGroup">Criar grupo +</button>
          </div>
        </div>
        <div id="groupGrid" class="card-grid"></div>
      </div>

      <div class="divider-hz"></div>

      <!-- Categorias + toggle -->
      <div class="section">
        <div class="section-head">
          <h2>Categorias</h2>
          <div class="muted">Ex.: Est√©tica, Tema Proposto, Apresenta√ß√£o, Pontua√ß√£o √önica‚Ä¶</div>
        </div>
        <div id="catGrid" class="chip-grid"></div>

        <div class="toggle-wrap">
          <div class="toggle">
            <input id="toggleIndividual" type="checkbox">
            <label for="toggleIndividual" class="toggle-ui"></label>
          </div>
          <div class="toggle-label">
            <span class="left">Pontuar apenas o grupo por inteiro</span>
            <span class="right">Dar pontos individuais aos alunos (ir√° somar na m√©dia)</span>
          </div>
        </div>
        <div style="margin-top:10px">
          <button class="btn blue" id="btnCreateCategory">Criar categoria +</button>
        </div>
      </div>
    </div>

    <div id="msg" class="muted" style="margin-top:14px"></div>
  </div>

  <!-- Modal/progresso -->
  <div class="modal hidden" id="progressModal" role="dialog" aria-modal="true">
    <div class="modal-box">
      <div class="modal-title" id="progressTitle">Processando‚Ä¶</div>
      <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
      <div class="modal-sub" id="progressSub">Aguarde um instante.</div>
      <div class="modal-actions"><button class="btn blue" id="modalOk" style="display:none">OK</button></div>
    </div>
  </div>

<script>
/* ===== CONFIG ===== */
const API_BASE = 'https://script.google.com/macros/s/AKfycbwNhItnXY_I9fu1MfQQZSAvuM9kHTsZO_E5Eq3XjPxlO_ZunrweL_JxxoiuA96amiOJ3w/exec';
const API = (API_BASE || '').trim().replace(/\s+/g,'');

/* ===== JSONP com timeout ===== */
function jsonp(url, {timeoutMs=12000} = {}){
  return new Promise((resolve, reject)=>{
    const cb = 'cb_' + Math.random().toString(36).slice(2);
    const s = document.createElement('script');
    let done = false;
    const timer = setTimeout(()=>{ if (done) return; done = true; cleanup(); reject(new Error('Falha JSONP (timeout) em: ' + url)); }, timeoutMs);
    function cleanup(){ clearTimeout(timer); try{ delete window[cb]; }catch(_){ } s.remove(); }
    window[cb] = (data)=>{ if (done) return; done = true; cleanup(); resolve(data); };
    s.onerror = ()=>{ if (done) return; done = true; cleanup(); reject(new Error('Falha JSONP (onerror) em: ' + url)); };
    s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
    document.body.appendChild(s);
  });
}
const el = id => document.getElementById(id);
const qs = key => new URLSearchParams(location.search).get(key);

/* ===== Modal de progresso ===== */
function showProgress(title, sub, showOk=false){
  el('progressTitle').textContent = title || 'Processando‚Ä¶';
  el('progressSub').textContent = sub || 'Aguarde um instante.';
  el('progressBar').style.width = '0%';
  el('modalOk').style.display = showOk ? '' : 'none';
  el('progressModal').classList.remove('hidden');
  let pct = 0, stop=false;
  const tick = setInterval(()=>{ if (stop) return;
    pct = Math.min(90, pct + 10 + Math.random()*10);
    el('progressBar').style.width = pct + '%';
  }, 120);
  return {
    done: (msg) => { stop=true; clearInterval(tick); el('progressTitle').textContent = msg||'Conclu√≠do!'; el('progressBar').style.width='100%'; el('modalOk').style.display=''; },
    fail: (m) => { stop=true; clearInterval(tick); el('progressTitle').textContent='Erro'; el('progressSub').textContent=m||'Tente novamente.'; el('modalOk').style.display=''; },
    hide: () => el('progressModal').classList.add('hidden')
  };
}

/* ===== Estado ===== */
let TEACHER = null;
let TEACHER_NAME = '';
let CLASSES = [];
let GROUPS = [];
let CATEGORIES = [];
let INDIVIDUAL_ON = false;
let suppressToggleEvent = false;

/* ===== Builders ===== */
function classCard(name, selected){
  const d = document.createElement('div');
  d.className = 'class-card' + (selected?' selected':'');
  d.dataset.id = name;
  d.innerHTML =
