<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Apresentação Games</title>
  <link rel="stylesheet" href="game-scores.css">

</head>
<body>
  <div class="wrap">
    <h1>Apresentação – <span id="classLabel"></span></h1>
    <div class="row">
      <select id="classSelect"></select>
      <button class="btn" id="printBtn">Imprimir / Salvar PDF</button>
      <button class="btn red" id="resetBtn">Resetar Turma</button>
    </div>
    <div id="grid" class="grid"></div>
    <div id="msg" class="muted"></div>
  </div>

<script>
const API_BASE = 'https://script.google.com/macros/s/AKfycbw6mWeutaJNdYmvz_baqnTJD70dMQGXwrJVOd687j_e_7f90q6dwU9M3RabHoHJ7fT_/exec';

function jsonp(url){
  return new Promise((resolve, reject)=>{
    const cb = 'cb_' + Math.random().toString(36).slice(2);
    const s = document.createElement('script');
    window[cb] = (data) => { resolve(data); delete window[cb]; s.remove(); };
    s.onerror = () => { delete window[cb]; reject(new Error('Falha JSONP')); };
    s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
    document.body.appendChild(s);
  });
}
function pct(x){ return Math.max(0, Math.min(100, Math.round(x))); }
function el(id){ return document.getElementById(id); }

let CURRENT_CLASS = null;

function card(g, idx){
  const p = pct(g.progress);
  const img = g.image || 'https://i.imgur.com/8Km9tLL.png';
  const el = document.createElement('div'); el.className='card';
  el.innerHTML = `
    <div class="head">
      <div class="rank">${idx+1}</div>
      <div class="name">${g.name}</div>
      <div class="total">${g.total.toFixed(2)} pts</div>
    </div>
    <div class="bar">
      <div class="fill" style="width:${p}%"></div>
      <div class="runner" style="left: calc(${p}% - 17px)">
        <img src="${img}" alt="${g.name}"/>
      </div>
    </div>
    <div class="members">${(g.members||[]).join(', ')}</div>
  `;
  return el;
}

async function loadClasses(){
  el('msg').textContent = 'Carregando turmas...';
  const data = await jsonp(`${API_BASE}?route=classes`);
  const classes = data.classes || [];
  const sel = el('classSelect'); sel.innerHTML = '';
  classes.forEach(c => {
    const o = document.createElement('option'); o.value = c; o.textContent = c; sel.appendChild(o);
  });
  const urlClass = new URLSearchParams(location.search).get('class');
  const saved = localStorage.getItem('selectedClass');
  CURRENT_CLASS = urlClass || saved || data.defaultClass || classes[0] || '1 Ano A';
  if (classes.includes(CURRENT_CLASS)) sel.value = CURRENT_CLASS;
  else { sel.value = classes[0]; CURRENT_CLASS = classes[0]; }
  el('classLabel').textContent = CURRENT_CLASS;
  el('msg').textContent = '';
}

async function loadStandings(){
  try{
    const data = await jsonp(`${API_BASE}?route=standings&class=${encodeURIComponent(CURRENT_CLASS)}`);
    const grid = el('grid'); grid.innerHTML='';
    (data.standings||[]).forEach((g, i) => grid.appendChild(card(g, i)));
    if ((data.standings||[]).length === 0) el('msg').textContent = 'Sem grupos para esta turma.';
    else el('msg').textContent = '';
  }catch(err){
    el('msg').textContent = 'Erro ao carregar: '+err.message;
  }
}

async function resetClass(){
  const ok = confirm('Você já salvou em PDF? Ao confirmar, TODOS os grupos, alunos e pontuações desta turma serão apagados.');
  if (!ok) return;
  try{
    const res = await jsonp(`${API_BASE}?route=resetClass&class=${encodeURIComponent(CURRENT_CLASS)}&confirm=yes`);
    if (res && res.ok){
      alert(`Reset concluído para ${CURRENT_CLASS}.\nRemovidos: ${res.cleared.groups} grupos, ${res.cleared.members} alunos, ${res.cleared.scores} pontuações.`);
      loadStandings();
    } else if (res && res.confirmRequired) {
      alert('Confirmação necessária (&confirm=yes).');
    } else {
      alert('Falha ao resetar.');
    }
  }catch(e){
    alert('Erro: ' + e.message);
  }
}

el('classSelect').addEventListener('change', ()=>{
  CURRENT_CLASS = el('classSelect').value;
  localStorage.setItem('selectedClass', CURRENT_CLASS);
  el('classLabel').textContent = CURRENT_CLASS;
  loadStandings();
});
el('printBtn').addEventListener('click', () => window.print());
el('resetBtn').addEventListener('click', resetClass);

(async function init(){
  await loadClasses();
  await loadStandings();
  setInterval(loadStandings, 15000);
})();
</script>
</body>
</html>
