<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Gameboard – Pontuação</title>
  <link rel="stylesheet" href="game-scores.css">
  <link rel="preconnect" href="https://script.google.com">
  <link rel="dns-prefetch" href="https://script.google.com">
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div id="crumbs" class="muted"></div>
        <button class="btn blue" id="btnBack">← Voltar ao painel</button>
      </div>

      <h2 class="title-xl" id="titleHead">Pontuação</h2>

      <div class="row">
        <div style="flex:1">
          <label class="label-lg">Grupo</label>
          <select id="groupSelect" class="big-select"></select>
        </div>
        <div style="flex:1">
          <label class="label-lg">Seu nome (opcional)</label>
          <input id="teacherNameLocal" class="big-input" placeholder="Ex.: Prof. Bruno"/>
        </div>
      </div>

      <h3 class="title-lg">Categorias (0–10)</h3>
      <div id="catInputs" class="grid4"></div>

      <div id="blockIndividual" class="hidden">
        <h3 class="title-lg">Apresentação por aluno (0–10)</h3>
        <div id="studentsBox" class="students"></div>
      </div>

      <h3 class="title-lg">Resumo</h3>
      <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <div class="badge">Média categorias: <b id="avgCats">0</b></div>
        <div class="badge hidden" id="avgPresWrap">Média apresentação: <b id="avgPres">0</b></div>
        <div class="badge">Pontuação da rodada (0–10): <b id="finalRound">0</b></div>
      </div>

      <div style="margin-top:18px;display:flex;gap:12px;align-items:center;">
        <button class="btn green btn-lg" id="submitScore">Salvar pontuação</button>
        <span class="muted" id="msg"></span>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="progressModal"><div class="modal-box">
    <div class="modal-title" id="progressTitle">Processando…</div>
    <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
    <div class="modal-sub" id="progressSub">Aguarde um instante.</div>
  </div></div>

<script>
const API_BASE = 'https://script.google.com/macros/s/AKfycbytSZsaBOsoI1ZhZNy8irvCaSFhYia9I9zeRJF5W1dNN-QlHGLpMQZlknuRVOKlIbIDzg/exec';
const API = (API_BASE || '').trim().replace(/\s+/g,'');

const el = id => document.getElementById(id);
const qs = name => new URLSearchParams(location.search).get(name);
function jsonp(url, {timeoutMs=12000} = {}){
  return new Promise((resolve, reject)=>{
    const cb = 'cb_' + Math.random().toString(36).slice(2);
    const s = document.createElement('script');
    let done=false;
    const timer = setTimeout(()=>{ if(done)return; done=true; cleanup(); reject(new Error('Falha JSONP (timeout)')); }, timeoutMs);
    function cleanup(){ clearTimeout(timer); try{ delete window[cb]; }catch(_){ } s.remove(); }
    window[cb] = (data)=>{ if(done)return; done=true; cleanup(); resolve(data); };
    s.onerror = ()=>{ if(done)return; done=true; cleanup(); reject(new Error('Falha JSONP (onerror)')); };
    s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb;
    document.body.appendChild(s);
  });
}
function showProgress(t, sub){
  el('progressTitle').textContent = t||'Processando…';
  el('progressSub').textContent = sub||'Aguarde…';
  el('progressBar').style.width='0%';
  el('progressModal').classList.remove('hidden');
  let p=0, k=setInterval(()=>{ p=Math.min(90,p+12); el('progressBar').style.width=p+'%'; },120);
  return { done:()=>{clearInterval(k); el('progressBar').style.width='100%'; el('progressModal').classList.add('hidden');} };
}
const clamp10 = v => Math.max(0, Math.min(10, parseFloat(v)||0));
const round2 = x => Math.round(x*100)/100;

let TEACHER=null, CLASS=null, GROUPS=[], CATEGORIES=[], INDIVIDUAL_ON=false;

async function loadMeta(){
  TEACHER = qs('teacher'); CLASS = qs('class');
  if (!TEACHER || !CLASS){ alert('Parâmetros faltando.'); return; }
  el('crumbs').textContent = `Professor: ${TEACHER} • Classe: ${CLASS}`;
  el('btnBack').onclick = ()=> location.href = `login.html?teacher=${encodeURIComponent(TEACHER)}&class=${encodeURIComponent(CLASS)}`;

  const meta = await jsonp(`${API}?route=categories&teacher=${encodeURIComponent(TEACHER)}&klass=${encodeURIComponent(CLASS)}`);
  CATEGORIES = meta.categories || []; INDIVIDUAL_ON = !!meta.individualOn;
  el('titleHead').textContent = `Pontuação — ${CLASS}`;

  await loadGroups();
  renderCatInputs();
  el('blockIndividual').classList.toggle('hidden', !INDIVIDUAL_ON);
  el('avgPresWrap').classList.toggle('hidden', !INDIVIDUAL_ON);
  compute();
}
async function loadGroups(){
  const data = await jsonp(`${API}?route=groups&teacher=${encodeURIComponent(TEACHER)}&klass=${encodeURIComponent(CLASS)}`);
  GROUPS = data.groups || [];
  const sel = el('groupSelect'); sel.innerHTML='';
  GROUPS.forEach(g=>{ const o=document.createElement('option'); o.value=g.id; o.textContent=g.name; sel.appendChild(o); });
  if (GROUPS[0]) sel.value = GROUPS[0].id;
  renderStudentsForScore();
}
function renderCatInputs(){
  const box = el('catInputs'); box.innerHTML='';
  (CATEGORIES||[]).forEach(c=>{
    const w=document.createElement('div');
    w.innerHTML = `<label class="label-lg">${c.name}</label><input class="big-input" type="number" step="0.1" min="0" max="10" data-cat="${c.name}">`;
    w.querySelector('input').addEventListener('input', compute);
    box.appendChild(w);
  });
}
function renderStudentsForScore(){
  const gid = el('groupSelect').value || (GROUPS[0] && GROUPS[0].id);
  const g = GROUPS.find(x=>x.id===gid) || {members:[]};
  const box = el('studentsBox'); box.innerHTML='';
  (g.members||[]).forEach(name=>{
    const d = document.createElement('div'); d.textContent = name; d.className='label-lg';
    const i = document.createElement('input'); i.type='number'; i.min='0'; i.max='10'; i.step='0.1'; i.dataset.pres='1'; i.placeholder='0–10'; i.className='big-input';
    i.addEventListener('input', compute);
    box.appendChild(d); box.appendChild(i);
  });
}
function compute(){
  const catInputs = Array.from(document.querySelectorAll('[data-cat]'));
  const catVals = catInputs.map(i=>clamp10(i.value)).filter(v=>!Number.isNaN(v));
  const avgCats = catVals.length ? catVals.reduce((a,b)=>a+b,0)/catVals.length : 0;
  el('avgCats').textContent = round2(avgCats);
  let avgPres = 0;
  if (INDIVIDUAL_ON){
    const presInputs = document.querySelectorAll('#studentsBox [data-pres]');
    const presVals = Array.from(presInputs).map(i=>clamp10(i.value)).filter(v=>!Number.isNaN(v));
    avgPres = presVals.length ? presVals.reduce((a,b)=>a+b,0)/presVals.length : 0;
    el('avgPres').textContent = round2(avgPres);
  }
  const final = INDIVIDUAL_ON ? (avgCats + avgPres)/2 : avgCats;
  el('finalRound').textContent = round2(final);
}
async function submitScore(){
  const gid = el('groupSelect').value || (GROUPS[0] && GROUPS[0].id);
  if (!gid){ alert('Selecione um grupo.'); return; }
  const cats = Array.from(document.querySelectorAll('[data-cat]')).map(i=>({ name:i.dataset.cat, score: clamp10(i.value) }));
  const pres = Array.from(document.querySelectorAll('#studentsBox [data-pres]'))
    .map((inp, idx)=>({ student: el('studentsBox').children[idx*2].textContent, score: clamp10(inp.value) }))
    .filter(p=>!isNaN(p.score));
  const prog = showProgress('Salvando pontuação…');
  try{
    const data = await jsonp(`${API}?route=submitScore&teacher=${encodeURIComponent(TEACHER)}&klass=${encodeURIComponent(CLASS)}&groupId=${encodeURIComponent(gid)}&categoriesJSON=${encodeURIComponent(JSON.stringify(cats))}&presentations=${encodeURIComponent(JSON.stringify(pres))}&submittedBy=${encodeURIComponent(el('teacherNameLocal').value||'')}`);
    prog.done();
    el('msg').innerHTML = data && data.ok ? `<span style="color:#22c55e">Salvo!</span>` : `<span style="color:#ef4444">Falha ao salvar.</span>`;
    document.querySelectorAll('#studentsBox [data-pres]').forEach(i=> i.value='');
    compute();
  }catch(e){ el('msg').innerHTML = `<span style="color:#ef4444">${e.message}</span>`; }
}

el('groupSelect').addEventListener('change', ()=>{ renderStudentsForScore(); compute(); });
el('submitScore').addEventListener('click', submitScore);

(async function init(){
  const savedName = localStorage.getItem('teacherNameLocal');
  if (savedName) el('teacherNameLocal').value = savedName;
  el('teacherNameLocal').addEventListener('change', ()=> localStorage.setItem('teacherNameLocal', el('teacherNameLocal').value));
  await loadMeta();
})();
</script>
</body>
</html>
