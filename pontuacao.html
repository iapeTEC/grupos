<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Gameboard – Pontuação</title>
  <link rel="stylesheet" href="game-scores.css">
</head>
<body>
  <div class="wrap">
    <!-- Barra de contexto com chips e “+” -->
    <div class="contextbar card" id="contextBar">
      <div class="chips">
        <span class="chip" id="chipTeacher">Professor: — <button class="chip-plus" id="chipTeacherPlus" title="Cadastrar/Selecionar professor">+</button></span>
        <span class="chip" id="chipClass">Turma: — <button class="chip-plus" id="chipClassPlus" title="Criar/Selecionar turma">+</button></span>
        <span class="chip" id="chipGroup">Grupo: — <button class="chip-plus" id="chipGroupPlus" title="Criar/Selecionar grupo">+</button></span>
        <span class="chip" id="chipMode">Modo: — <button class="chip-plus" id="chipModePlus" title="Escolher modo de pontuação">+</button></span>
      </div>
      <button class="btn blue" id="toggleSetup">Ocultar configuração</button>
    </div>

    <!-- WIZARD -->
    <div class="card" id="setupCard">
      <h1 style="margin:0 0 6px">Bem-vindo, Professor!</h1>
      <p class="muted" id="wizardIntro">Selecione seu nome abaixo, ou cadastre-se no botão <b>“Cadastrar professor +”</b>.</p>

      <div class="wizard">
        <!-- Passo 1: Professor -->
        <section class="step" id="stepTeacher">
          <h2>1) Professor</h2>
          <div class="row">
            <select id="teacherSelect" style="min-width:260px"></select>
            <button class="btn green plus" id="btnCreateTeacher">Cadastrar professor +</button>
          </div>
          <div class="row hidden" id="teacherCreateRow">
            <input id="newTeacher" placeholder="Seu nome completo"/>
            <select id="modeSelect" title="Tipo de pontuação (pode mudar depois)">
              <option value="mixed">Misto (5/5)</option>
              <option value="group">Grupo (10/0)</option>
              <option value="individual">Individual (0/10)</option>
            </select>
            <button class="btn green" id="confirmCreateTeacher">Criar sala</button>
          </div>
          <div class="row">
            <button class="btn blue" id="goStep2">Continuar</button>
          </div>
        </section>

        <!-- Passo 2: Turma -->
        <section class="step hidden" id="stepClass">
          <h2>2) Turma</h2>
          <div class="row">
            <select id="classSelect" style="min-width:260px"></select>
            <button class="btn green plus" id="btnCreateClass">Cadastrar turma +</button>
          </div>
          <div class="row hidden" id="classCreateRow">
            <input id="newClass" placeholder="Ex.: 3º Ano Fundamental"/>
            <button class="btn green" id="confirmCreateClass">Criar</button>
          </div>
          <div class="row">
            <button class="btn blue" id="goStep3">Continuar</button>
          </div>
        </section>

        <!-- Passo 3: Grupo -->
        <section class="step hidden" id="stepGroup">
          <h2>3) Grupo</h2>
          <div class="row">
            <input id="groupName" placeholder="Nome do grupo"/>
            <input id="groupImage" placeholder="URL da imagem (opcional)"/>
            <button class="btn green" id="confirmCreateGroup">Cadastrar grupo</button>
          </div>
          <div class="muted">Ou <a id="uploadLink" href="#" target="_blank">enviar imagem pelo formulário</a>.</div>
          <div class="row">
            <select id="groupSelect" style="min-width:260px"></select>
            <button class="btn purple plus" id="btnMoreGroup">Criar mais um grupo +</button>
          </div>
          <div class="row">
            <button class="btn blue" id="goStep4">Continuar</button>
          </div>
        </section>

        <!-- Passo 4: Modo de pontuação -->
        <section class="step hidden" id="stepMode">
          <h2>4) Como deseja avaliar?</h2>
          <div class="mode-grid">
            <button class="mode-card" data-mode="group">
              <div class="mode-title">Grupo</div>
              <div class="mode-desc">Nota (0–10) por grupo</div>
            </button>
            <button class="mode-card" data-mode="individual">
              <div class="mode-title">Individual</div>
              <div class="mode-desc">Nota (0–10) por aluno</div>
            </button>
            <button class="mode-card" data-mode="mixed">
              <div class="mode-title">Misto</div>
              <div class="mode-desc">Categorias + apresentação (soma 10)</div>
            </button>
          </div>
          <div class="muted" id="weightsInfo">Pesos atuais: 5/5</div>
          <div class="row">
            <button class="btn blue" id="goStep5">Continuar</button>
          </div>
        </section>

        <!-- Passo 5: Alunos -->
        <section class="step hidden" id="stepStudents">
          <h2>5) Alunos do grupo</h2>
          <div id="studentInputs"></div>
          <div class="row">
            <button class="btn green plus" id="addStudentField">Adicionar aluno +</button>
          </div>
          <div class="row">
            <button class="btn green" id="confirmStudents">Enviar</button>
            <button class="btn purple" id="finishWizard">Finalizar / Ir para pontuação</button>
            <button class="btn blue" id="moreGroupFromStudents">Criar outro grupo</button>
          </div>
        </section>
      </div>
    </div>

    <!-- ÁREA DE PONTUAÇÃO (fica depois do wizard) -->
    <div class="card" id="scoreCard">
      <h2 style="margin:0 0 8px">Pontuação</h2>
      <div class="row">
        <div style="flex:1">
          <label>Grupo</label>
          <select id="scoreGroup"></select>
        </div>
        <div style="flex:1">
          <label>Seu nome (opcional)</label>
          <input id="teacherNameLocal" placeholder="Ex.: Prof. Bruno"/>
        </div>
      </div>

      <h2>Quatro categorias (0–10)</h2>
      <div class="grid4">
        <div><label>Visual</label><input type="number" id="c1" min="0" max="10" step="0.1"/></div>
        <div><label>Trilha Sonora</label><input type="number" id="c2" min="0" max="10" step="0.1"/></div>
        <div><label>Proposta</label><input type="number" id="c3" min="0" max="10" step="0.1"/></div>
        <div><label>Vocabulário/Roteiro</label><input type="number" id="c4" min="0" max="10" step="0.1"/></div>
      </div>

      <h2>Apresentação por aluno (0–10)</h2>
      <div id="studentsBox" class="students"></div>

      <h2>Resumo</h2>
      <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <div class="badge">Média 4 categorias: <b id="avgCats">0</b></div>
        <div class="badge">Média apresentação: <b id="avgPres">0</b></div>
        <div class="badge">Pesos (cat/ind): <b id="weightsLabel">5/5</b></div>
        <div class="badge">Pontuação da rodada (0–10): <b id="finalRound">0</b></div>
      </div>

      <div style="margin-top:12px;display:flex;gap:12px;align-items:center;">
        <button class="btn green" id="submitScoreBtn">Salvar pontuação</button>
        <span class="muted" id="msg"></span>
      </div>
    </div>
  </div>

  <!-- MODAL DE PROGRESSO -->
  <div class="modal hidden" id="progressModal" role="dialog" aria-live="assertive" aria-modal="true">
    <div class="modal-box">
      <div class="modal-title" id="progressTitle">Processando…</div>
      <div class="progress"><div class="progress-bar" id="progressBar" style="width:0%"></div></div>
      <div class="modal-sub" id="progressSub">Aguarde um instante.</div>
    </div>
  </div>

<script>
const API_BASE = 'https://script.google.com/macros/s/AKfycbyCuXJrLRxoJ3DqezUUDNDxgApYKME1-nUgWGThHMKWscnEwlqbcGC9-qhaj_lGBAUG/exec';

function jsonp(url){
  return new Promise((resolve, reject)=>{
    const cb = 'cb_' + Math.random().toString(36).slice(2);
    const s = document.createElement('script');
    window[cb] = (data) => { resolve(data); delete window[cb]; s.remove(); };
    s.onerror = () => { delete window[cb]; reject(new Error('Falha JSONP')); };
    s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
    document.body.appendChild(s);
  });
}
const el = id => document.getElementById(id);
const clamp10 = v => Math.max(0, Math.min(10, parseFloat(v)||0));
const round2 = x => Math.round(x*100)/100;

let TEACHER = null;
let CLASSES = [];
let GROUPS = [];
let WEIGHTS = {cat:5, ind:5};

// --------- Modal de progresso ---------
function showProgress(title, sub){
  el('progressTitle').textContent = title || 'Processando…';
  el('progressSub').textContent = sub || 'Aguarde um instante.';
  el('progressBar').style.width = '0%';
  el('progressModal').classList.remove('hidden');
  // anima até 100%
  let pct = 0;
  return new Promise(resolve=>{
    const t = setInterval(()=>{
      pct += 12 + Math.random()*10;
      if (pct >= 100){ pct = 100; clearInterval(t); setTimeout(resolve, 250); }
      el('progressBar').style.width = pct + '%';
    }, 120);
  });
}
function hideProgress(){ el('progressModal').classList.add('hidden'); }

// --------- Chips/updaters ----------
function updateChips(){
  el('chipTeacher').firstChild.textContent = 'Professor: ' + (TEACHER || '—') + ' ';
  const klass = el('classSelect').value || '—';
  el('chipClass').firstChild.textContent = 'Turma: ' + klass + ' ';
  const gid = el('scoreGroup').value || (GROUPS[0] && GROUPS[0].id) || '—';
  const gname = (GROUPS.find(g=>g.id===gid)||{}).name || '—';
  el('chipGroup').firstChild.textContent = 'Grupo: ' + gname + ' ';
  el('chipMode').firstChild.textContent = 'Modo: ' + (WEIGHTS.cat===10?'grupo':WEIGHTS.ind===10?'individual':'misto') + ' ';
}

// --------- Wizard helpers ----------
function goStep(idToShow){
  ['stepTeacher','stepClass','stepGroup','stepMode','stepStudents'].forEach(id=>{
    el(id).classList.toggle('hidden', id!==idToShow);
  });
  window.scrollTo({ top: el('setupCard').offsetTop - 12, behavior:'smooth' });
  updateChips();
}
function driveDirect(viewUrl){
  const m = String(viewUrl||'').match(/\/d\/([a-zA-Z0-9_-]{20,})\//);
  if (m) return 'https://drive.google.com/uc?export=view&id=' + m[1];
  return viewUrl;
}

// --------- API calls ----------
async function loadTeachers(){
  const data = await jsonp(`${API_BASE}?route=teachers`);
  const sel = el('teacherSelect'); sel.innerHTML='';
  (data.teachers||[]).forEach(t=>{
    const o=document.createElement('option'); o.value=t.id; o.textContent=t.name; sel.appendChild(o);
  });
  const saved = localStorage.getItem('teacherId');
  if (saved && (data.teachers||[]).some(t=>t.id===saved)) sel.value = saved;
  TEACHER = sel.value || null;
  updateChips();
}

async function createTeacher(name, mode){
  await showProgress('Criando sala do professor…','Preparando planilha no Drive');
  const res = await jsonp(`${API_BASE}?route=createTeacher&teacherName=${encodeURIComponent(name)}&mode=${encodeURIComponent(mode)}`);
  hideProgress();
  if (res && res.ok){
    WEIGHTS = res.weights || {cat:5,ind:5};
    await loadTeachers();
    el('teacherSelect').value = res.teacherId;
    TEACHER = res.teacherId;
    localStorage.setItem('teacherId', TEACHER);
    updateChips();
    return true;
  }
  alert('Falha ao criar professor.');
  return false;
}

async function setScoring(mode){
  if (!TEACHER) return;
  await showProgress('Salvando modo de pontuação…');
  const res = await jsonp(`${API_BASE}?route=setScoring&teacher=${encodeURIComponent(TEACHER)}&mode=${encodeURIComponent(mode)}`);
  hideProgress();
  if (res && res.ok){ WEIGHTS = res.weights || {cat:5,ind:5}; updateChips(); }
}

async function loadClasses(){
  if (!TEACHER) return;
  const data = await jsonp(`${API_BASE}?route=classes&teacher=${encodeURIComponent(TEACHER)}`);
  CLASSES = data.classes||[];
  const sel = el('classSelect'); sel.innerHTML='';
  CLASSES.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
  const saved = localStorage.getItem('className');
  if (saved && CLASSES.includes(saved)) sel.value=saved;
  updateChips();
  await loadGroups();
}

async function createClass(cname){
  await showProgress('Criando turma…');
  await jsonp(`${API_BASE}?route=createClass&teacher=${encodeURIComponent(TEACHER)}&class=${encodeURIComponent(cname)}`);
  hideProgress();
  await loadClasses();
  el('classSelect').value = cname;
  localStorage.setItem('className', cname);
  updateChips();
}

async function loadGroups(){
  if (!TEACHER) return;
  const klass = el('classSelect').value || '';
  const data = await jsonp(`${API_BASE}?route=groups&teacher=${encodeURIComponent(TEACHER)}&class=${encodeURIComponent(klass)}`);
  GROUPS = data.groups||[];
  // para criação + pontuação
  [el('groupSelect'), el('scoreGroup')].forEach(sel=>{
    sel.innerHTML='';
    GROUPS.forEach(g=>{ const o=document.createElement('option'); o.value=g.id; o.textContent=g.name; sel.appendChild(o); });
  });
  updateChips();
  renderStudentsForScore();
  updateUploadLink();
  compute();
}

async function addGroup(name, imageURL){
  const klass = el('classSelect').value || '';
  await showProgress('Criando grupo…');
  await jsonp(`${API_BASE}?route=addGroup&teacher=${encodeURIComponent(TEACHER)}&class=${encodeURIComponent(klass)}&groupName=${encodeURIComponent(name)}&imageURL=${encodeURIComponent(driveDirect(imageURL||''))}`);
  hideProgress();
  await loadGroups();
  const g = GROUPS.find(x=>x.name===name) || GROUPS[GROUPS.length-1];
  if (g){ el('groupSelect').value = g.id; el('scoreGroup').value = g.id; }
  updateChips();
}

async function addStudentsToCurrent(names){
  const klass = el('classSelect').value || '';
  const gid = el('groupSelect').value || '';
  if (!gid) { alert('Selecione um grupo.'); return false; }
  await showProgress('Adicionando alunos…');
  await jsonp(`${API_BASE}?route=addStudents&teacher=${encodeURIComponent(TEACHER)}&class=${encodeURIComponent(klass)}&groupId=${encodeURIComponent(gid)}&students=${encodeURIComponent(JSON.stringify(names))}`);
  hideProgress();
  await loadGroups();
  return true;
}

// --------- Pontuação ----------
function renderStudentsForScore(){
  const gid = el('scoreGroup').value || (GROUPS[0] && GROUPS[0].id);
  const g = GROUPS.find(x=>x.id===gid) || {members:[]};
  const box = el('studentsBox'); box.innerHTML='';
  (g.members||[]).forEach(name=>{
    const d = document.createElement('div'); d.textContent = name;
    const i = document.createElement('input'); i.type='number'; i.min='0'; i.max='10'; i.step='0.1'; i.dataset.pres='1'; i.placeholder='0–10';
    i.addEventListener('input', compute);
    box.appendChild(d); box.appendChild(i);
  });
}
function compute(){
  const cats = ['c1','c2','c3','c4'].map(id=> clamp10(el(id).value));
  const avgCats = (cats[0]+cats[1]+cats[2]+cats[3]) / 4;
  const presInputs = document.querySelectorAll('#studentsBox [data-pres]');
  const presVals = Array.from(presInputs).map(i=>clamp10(i.value)).filter(v=>!Number.isNaN(v));
  const avgPres = presVals.length ? presVals.reduce((a,b)=>a+b,0)/presVals.length : 0;
  el('avgCats').textContent = round2(avgCats);
  el('avgPres').textContent = round2(avgPres);
  el('weightsLabel').textContent = `${WEIGHTS.cat}/${WEIGHTS.ind}`;
  el('finalRound').textContent = round2((avgCats*(WEIGHTS.cat/10)) + (avgPres*(WEIGHTS.ind/10)));
}
async function submitScore(){
  if (!TEACHER){ alert('Selecione/cadastre um professor.'); return; }
  const klass = el('classSelect').value || '';
  const gid = el('scoreGroup').value || '';
  if (!gid){ alert('Selecione o grupo.'); return; }
  const cats = ['c1','c2','c3','c4'].map(id=> clamp10(el(id).value));
  const pres = Array.from(document.querySelectorAll('#studentsBox [data-pres]'))
    .map((inp, idx)=>({ student: el('studentsBox').children[idx*2].textContent, score: clamp10(inp.value) }))
    .filter(p=>!isNaN(p.score));
  await showProgress('Salvando pontuação…');
  const data = await jsonp(`${API_BASE}?route=submitScore&teacher=${encodeURIComponent(TEACHER)}&class=${encodeURIComponent(klass)}&groupId=${encodeURIComponent(gid)}&c1=${cats[0]}&c2=${cats[1]}&c3=${cats[2]}&c4=${cats[3]}&submittedBy=${encodeURIComponent(el('teacherNameLocal').value||'')}&presentations=${encodeURIComponent(JSON.stringify(pres))}`);
  hideProgress();
  if (data && data.ok){
    el('msg').innerHTML = `<span style="color:#22c55e">Salvo! Rodada = ${data.finalRound.toFixed(2)} (cat: ${data.avgCategories.toFixed(2)} / ind: ${data.presentationAvg.toFixed(2)})</span>`;
    document.querySelectorAll('#studentsBox [data-pres]').forEach(i=> i.value='');
    compute();
  }else{
    el('msg').innerHTML = `<span style="color:#ef4444">Falha ao salvar.</span>`;
  }
}
function updateUploadLink(){
  const klass = el('classSelect').value || '';
  const gid = el('groupSelect').value || '';
  el('uploadLink').href = `${API_BASE}?route=uploadForm&teacher=${encodeURIComponent(TEACHER||'')}&class=${encodeURIComponent(klass)}&groupId=${encodeURIComponent(gid||el('groupName').value||'')}`;
}

// --------- Eventos do wizard ----------
el('btnCreateTeacher').addEventListener('click', ()=> el('teacherCreateRow').classList.toggle('hidden'));
el('confirmCreateTeacher').addEventListener('click', async ()=>{
  const name = el('newTeacher').value.trim();
  const mode = el('modeSelect').value;
  if (!name){ alert('Informe seu nome.'); return; }
  const ok = await createTeacher(name, mode);
  if (ok){ await setScoring(mode); await loadClasses(); goStep('stepClass'); }
});
el('goStep2').addEventListener('click', async ()=>{
  TEACHER = el('teacherSelect').value || null;
  if (!TEACHER){ alert('Selecione um professor.'); return; }
  localStorage.setItem('teacherId', TEACHER);
  await loadClasses();
  goStep('stepClass');
});

el('btnCreateClass').addEventListener('click', ()=> el('classCreateRow').classList.toggle('hidden'));
el('confirmCreateClass').addEventListener('click', async ()=>{
  const cname = el('newClass').value.trim();
  if (!cname){ alert('Informe a turma.'); return; }
  await createClass(cname);
  goStep('stepGroup');
});
el('goStep3').addEventListener('click', ()=> goStep('stepGroup'));

el('confirmCreateGroup').addEventListener('click', async ()=>{
  const name = el('groupName').value.trim();
  await addGroup(name, el('groupImage').value.trim());
  el('groupName').value=''; el('groupImage').value='';
});
el('btnMoreGroup').addEventListener('click', ()=> el('groupName').focus());
el('goStep4').addEventListener('click', ()=> goStep('stepMode'));

document.querySelectorAll('.mode-card').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const mode = btn.dataset.mode;
    await setScoring(mode);
    el('weightsInfo').textContent = `Pesos atuais: ${WEIGHTS.cat}/${WEIGHTS.ind}`;
  });
});
el('goStep5').addEventListener('click', ()=> goStep('stepStudents'));

function addStudentField(value=''){
  const wrap = document.createElement('div');
  wrap.className='row';
  const inp = document.createElement('input'); inp.placeholder='Nome do aluno'; inp.value=value;
  const del = document.createElement('button'); del.className='btn red'; del.textContent='–'; del.title='Remover';
  del.addEventListener('click', ()=> wrap.remove());
  wrap.appendChild(inp); wrap.appendChild(del);
  el('studentInputs').appendChild(wrap);
}
el('addStudentField').addEventListener('click', ()=> addStudentField());
el('confirmStudents').addEventListener('click', async ()=>{
  const names = Array.from(el('studentInputs').querySelectorAll('input')).map(i=>i.value.trim()).filter(Boolean);
  if (!names.length){ alert('Adicione pelo menos um aluno.'); return; }
  const ok = await addStudentsToCurrent(names);
  if (ok){ el('studentInputs').innerHTML=''; alert('Alunos adicionados com sucesso!'); }
});
el('finishWizard').addEventListener('click', ()=>{
  el('setupCard').classList.add('hidden');
  el('toggleSetup').textContent = 'Mostrar configuração';
  window.scrollTo({ top: el('scoreCard').offsetTop - 10, behavior:'smooth' });
});
el('moreGroupFromStudents').addEventListener('click', ()=> { goStep('stepGroup'); });

// Score events
['c1','c2','c3','c4'].forEach(id=> el(id).addEventListener('input', compute));
el('scoreGroup').addEventListener('change', ()=>{ renderStudentsForScore(); compute(); updateChips(); });
el('classSelect').addEventListener('change', async ()=>{ localStorage.setItem('className', el('classSelect').value); await loadGroups(); updateChips(); });
el('confirmCreateGroup').addEventListener('click', updateUploadLink);
el('groupSelect').addEventListener('change', updateUploadLink);
el('submitScoreBtn').addEventListener('click', submitScore);

// Botões da context bar
el('chipTeacherPlus').addEventListener('click', ()=> goStep('stepTeacher'));
el('chipClassPlus').addEventListener('click', ()=> goStep('stepClass'));
el('chipGroupPlus').addEventListener('click', ()=> goStep('stepGroup'));
el('chipModePlus').addEventListener('click', ()=> goStep('stepMode'));
el('toggleSetup').addEventListener('click', ()=>{
  const hidden = el('setupCard').classList.toggle('hidden');
  el('toggleSetup').textContent = hidden ? 'Mostrar configuração' : 'Ocultar configuração';
});

// Init
(async function init(){
  // por padrão mostra Step 1
  el('scoreCard').classList.remove('hidden'); // área de pontuação já visível
  await loadTeachers();
})();
</script>
</body>
</html>
